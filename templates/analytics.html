<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analytics - Finansly</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      :root {
        --bg-primary: #0d0d0d;
        --bg-secondary: #161616;
        --bg-tertiary: #1e1e1e;
        --bg-elevated: #252525;
        --accent-primary: #ffab40;
        --accent-hover: #ffb94d;
        --accent-active: #ff9800;
        --text-primary: #ffffff;
        --text-secondary: #b0b0b0;
        --text-muted: #707070;
        --success: #4caf50;
        --success-light: #81c784;
        --error: #ef5350;
        --error-bg: rgba(239, 83, 80, 0.1);
        --border: #2d2d2d;
        --border-light: #3d3d3d;
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
        --shadow-md: 0 4px 24px rgba(0, 0, 0, 0.4);
        --transition: 200ms ease;
        --gold-color: #ffd700;
        --usd-color: #4fc3f7;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
      }

      /* Header */
      .header {
        position: sticky;
        top: 0;
        z-index: 100;
        background: rgba(13, 13, 13, 0.9);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border);
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 32px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        text-decoration: none;
      }

      .brand-logo {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        background: linear-gradient(
          135deg,
          var(--accent-primary) 0%,
          var(--accent-active) 100%
        );
        border-radius: var(--radius-sm);
      }

      .brand-logo svg {
        width: 22px;
        height: 22px;
        color: var(--bg-primary);
      }

      .brand-name {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
        letter-spacing: -0.5px;
      }

      .nav {
        display: flex;
        gap: 8px;
      }

      .nav-link {
        padding: 8px 16px;
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: var(--transition);
      }

      .nav-link:hover {
        color: var(--text-primary);
        background: var(--bg-tertiary);
      }

      .nav-link.active {
        color: var(--accent-primary);
        background: rgba(255, 171, 64, 0.1);
      }

      .btn-logout {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 16px;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
        font-family: inherit;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        cursor: pointer;
        transition: var(--transition);
      }

      .btn-logout:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border-color: var(--border-light);
      }

      .btn-logout svg {
        width: 16px;
        height: 16px;
      }

      /* Main Content */
      .main {
        max-width: 1200px;
        margin: 0 auto;
        padding: 32px 24px 64px;
      }

      /* Page Header */
      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 32px;
        flex-wrap: wrap;
        gap: 16px;
      }

      .page-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
        letter-spacing: -0.5px;
        margin-bottom: 4px;
      }

      .page-subtitle {
        font-size: 15px;
        color: var(--text-secondary);
      }

      /* Filter Tabs */
      .filter-tabs {
        display: flex;
        gap: 4px;
        background: var(--bg-secondary);
        padding: 4px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
      }

      .filter-tab {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        background: transparent;
        color: var(--text-secondary);
        font-family: inherit;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
      }

      .filter-tab:hover {
        color: var(--text-primary);
      }

      .filter-tab.active {
        background: var(--bg-elevated);
        color: var(--text-primary);
      }

      /* Metrics Grid */
      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 32px;
      }

      .metric-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 20px;
        transition: var(--transition);
      }

      .metric-card:hover {
        border-color: var(--border-light);
      }

      .metric-card.highlight {
        background: linear-gradient(
          135deg,
          rgba(255, 171, 64, 0.1) 0%,
          rgba(255, 152, 0, 0.05) 100%
        );
        border-color: rgba(255, 171, 64, 0.3);
      }

      .metric-label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        font-weight: 500;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }

      .metric-label svg {
        width: 14px;
        height: 14px;
      }

      .metric-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        letter-spacing: -0.5px;
        font-variant-numeric: tabular-nums;
      }

      .metric-value.accent {
        color: var(--accent-primary);
      }

      .metric-value.success {
        color: var(--success);
      }

      .metric-value.error {
        color: var(--error);
      }

      .metric-unit {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary);
        margin-left: 4px;
      }

      .metric-change {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        margin-top: 8px;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
      }

      .metric-change.positive {
        background: rgba(76, 175, 80, 0.15);
        color: var(--success);
      }

      .metric-change.negative {
        background: rgba(239, 83, 80, 0.15);
        color: var(--error);
      }

      .metric-change svg {
        width: 12px;
        height: 12px;
      }

      /* Charts Grid */
      .charts-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 24px;
        margin-bottom: 32px;
      }

      @media (min-width: 900px) {
        .charts-grid {
          grid-template-columns: 2fr 1fr;
        }
      }

      /* Card */
      .card {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        overflow: hidden;
      }

      .card-header {
        padding: 20px 24px 0;
      }

      .card-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
      }

      .card-subtitle {
        font-size: 13px;
        color: var(--text-muted);
      }

      .card-body {
        padding: 20px 24px 24px;
      }

      /* Chart Container */
      .chart-container {
        position: relative;
        height: 300px;
      }

      .chart-container.small {
        height: 250px;
      }

      /* Composition Legend */
      .composition-legend {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 16px;
      }

      .legend-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: var(--bg-tertiary);
        border-radius: var(--radius-sm);
      }

      .legend-label {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }

      .legend-dot.gold {
        background: var(--gold-color);
      }

      .legend-dot.usd {
        background: var(--usd-color);
      }

      .legend-text {
        font-size: 14px;
        color: var(--text-secondary);
      }

      .legend-value {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        font-variant-numeric: tabular-nums;
      }

      /* Price Tracking */
      .price-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 24px;
      }

      /* Loading State */
      .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(13, 13, 13, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: var(--transition);
      }

      .loading-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border);
        border-top-color: var(--accent-primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Empty State */
      .empty-state {
        padding: 64px 24px;
        text-align: center;
      }

      .empty-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto 16px;
        color: var(--text-muted);
        opacity: 0.5;
      }

      .empty-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
      }

      .empty-text {
        font-size: 14px;
        color: var(--text-muted);
        margin-bottom: 24px;
      }

      .btn-primary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 24px;
        background: linear-gradient(
          135deg,
          var(--accent-primary) 0%,
          var(--accent-active) 100%
        );
        color: #0d0d0d;
        border: none;
        border-radius: var(--radius-sm);
        font-family: inherit;
        font-size: 14px;
        font-weight: 600;
        text-decoration: none;
        cursor: pointer;
        transition: var(--transition);
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 16px rgba(255, 171, 64, 0.3);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .header-left {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }

        .main {
          padding: 24px 16px 48px;
        }

        .page-header {
          flex-direction: column;
        }

        .page-title {
          font-size: 24px;
        }

        .metrics-grid {
          grid-template-columns: 1fr 1fr;
        }

        .metric-value {
          font-size: 20px;
        }

        .chart-container {
          height: 250px;
        }
      }

      @media (max-width: 480px) {
        .metrics-grid {
          grid-template-columns: 1fr;
        }

        .nav {
          width: 100%;
          overflow-x: auto;
        }
      }
    </style>
  </head>
  <body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
    </div>

    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="header-left">
          <a href="{{ url_for('index') }}" class="brand">
            <div class="brand-logo">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"
                />
              </svg>
            </div>
            <span class="brand-name">Finansly</span>
          </a>
          <nav class="nav">
            <a href="{{ url_for('index') }}" class="nav-link">Dashboard</a>
            <a href="{{ url_for('analytics') }}" class="nav-link active"
              >Analytics</a
            >
          </nav>
        </div>
        <a href="{{ url_for('logout') }}" class="btn-logout">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Logout
        </a>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main" id="mainContent">
      <div class="page-header">
        <div>
          <h1 class="page-title">Analytics</h1>
          <p class="page-subtitle">
            Track your wealth performance and portfolio trends
          </p>
        </div>
        <div class="filter-tabs">
          <button class="filter-tab" data-period="7">7 Days</button>
          <button class="filter-tab" data-period="30">30 Days</button>
          <button class="filter-tab active" data-period="all">All Time</button>
        </div>
      </div>

      <!-- Empty State (shown when no data) -->
      <div class="empty-state" id="emptyState" style="display: none">
        <svg
          class="empty-icon"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
        >
          <path d="M3 3v18h18" />
          <path d="M18 17V9" />
          <path d="M13 17V5" />
          <path d="M8 17v-3" />
        </svg>
        <h3 class="empty-title">No data available</h3>
        <p class="empty-text">
          Start tracking your wealth to see analytics and insights
        </p>
        <a href="{{ url_for('index') }}" class="btn-primary">Go to Dashboard</a>
      </div>

      <!-- Analytics Content -->
      <div id="analyticsContent">
        <!-- Key Metrics -->
        <div class="metrics-grid" id="metricsGrid">
          <div class="metric-card highlight">
            <div class="metric-label">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
              </svg>
              Current Wealth
            </div>
            <div class="metric-value accent" id="currentWealth">—</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
                <polyline points="17 6 23 6 23 12" />
              </svg>
              All-Time High
            </div>
            <div class="metric-value" id="allTimeHigh">—</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="23 18 13.5 8.5 8.5 13.5 1 6" />
                <polyline points="17 18 23 18 23 12" />
              </svg>
              All-Time Low
            </div>
            <div class="metric-value" id="allTimeLow">—</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <line x1="12" y1="1" x2="12" y2="23" />
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
              </svg>
              Total Change
            </div>
            <div class="metric-value" id="totalChange">—</div>
            <div class="metric-change" id="totalChangePercent">
              <span>—</span>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
          <!-- Wealth Over Time Chart -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Wealth Over Time</h2>
              <p class="card-subtitle">Your total portfolio value trend</p>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="wealthChart"></canvas>
              </div>
            </div>
          </div>

          <!-- Portfolio Composition Chart -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Portfolio Composition</h2>
              <p class="card-subtitle">Asset allocation breakdown</p>
            </div>
            <div class="card-body">
              <div class="chart-container small">
                <canvas id="compositionChart"></canvas>
              </div>
              <div class="composition-legend">
                <div class="legend-item">
                  <div class="legend-label">
                    <span class="legend-dot gold"></span>
                    <span class="legend-text">Gold Holdings</span>
                  </div>
                  <span class="legend-value" id="goldPercent">—</span>
                </div>
                <div class="legend-item">
                  <div class="legend-label">
                    <span class="legend-dot usd"></span>
                    <span class="legend-text">USD Balance</span>
                  </div>
                  <span class="legend-value" id="usdPercent">—</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Price Tracking -->
        <div class="price-grid">
          <!-- Gold Price Chart -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Gold Price Trend</h2>
              <p class="card-subtitle">24K gold price in EGP per gram</p>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="goldPriceChart"></canvas>
              </div>
            </div>
          </div>

          <!-- USD Rate Chart -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">USD/EGP Rate</h2>
              <p class="card-subtitle">Exchange rate over time</p>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="usdRateChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      // Global state
      let analyticsData = null;
      let currentPeriod = "all";
      let charts = {};

      // Chart.js default configuration
      Chart.defaults.color = "#707070";
      Chart.defaults.borderColor = "#2D2D2D";
      Chart.defaults.font.family =
        "'Inter', -apple-system, BlinkMacSystemFont, sans-serif";

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        setupFilterTabs();
        fetchAnalyticsData();
      });

      // Filter tabs
      function setupFilterTabs() {
        document.querySelectorAll(".filter-tab").forEach((tab) => {
          tab.addEventListener("click", function () {
            document
              .querySelectorAll(".filter-tab")
              .forEach((t) => t.classList.remove("active"));
            this.classList.add("active");
            currentPeriod = this.dataset.period;
            updateCharts();
          });
        });
      }

      // Fetch data
      async function fetchAnalyticsData() {
        showLoading(true);
        try {
          const response = await fetch("/api/analytics");
          if (!response.ok) throw new Error("Failed to fetch data");
          analyticsData = await response.json();

          if (!analyticsData.data || analyticsData.data.length === 0) {
            showEmptyState(true);
          } else {
            showEmptyState(false);
            updateCharts();
          }
        } catch (error) {
          console.error("Error fetching analytics:", error);
          showEmptyState(true);
        } finally {
          showLoading(false);
        }
      }

      // Filter data by period
      function filterDataByPeriod(data) {
        if (currentPeriod === "all") return data;

        const days = parseInt(currentPeriod);
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - days);

        return data.filter((item) => new Date(item.timestamp) >= cutoffDate);
      }

      // Filter price history by period
      function filterPriceHistoryByPeriod(priceArray) {
        if (!priceArray || !Array.isArray(priceArray)) return [];
        if (currentPeriod === "all") return priceArray;

        const days = parseInt(currentPeriod);
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - days);

        return priceArray.filter((item) => new Date(item.timestamp) >= cutoffDate);
      }

      // Update all charts
      function updateCharts() {
        if (!analyticsData || !analyticsData.data) return;

        const filteredData = filterDataByPeriod(analyticsData.data);
        const priceHistory = analyticsData.price_history || {};
        
        if (filteredData.length === 0) {
          showEmptyState(true);
          return;
        }

        showEmptyState(false);
        updateMetrics(filteredData);
        updateWealthChart(filteredData);
        updateCompositionChart(filteredData);
        
        // Use price_history for trend charts (more frequent data)
        const goldPriceData = filterPriceHistoryByPeriod(priceHistory.gold_24k);
        const usdRateData = filterPriceHistoryByPeriod(priceHistory.usd);
        
        updateGoldPriceChart(goldPriceData.length > 0 ? goldPriceData : filteredData);
        updateUsdRateChart(usdRateData.length > 0 ? usdRateData : filteredData);
      }

      // Update metrics
      function updateMetrics(data) {
        const latest = data[data.length - 1];
        const first = data[0];

        // Current wealth
        document.getElementById("currentWealth").innerHTML =
          formatNumber(latest.total_wealth) +
          '<span class="metric-unit">EGP</span>';

        // All-time high/low
        const wealthValues = data.map((d) => d.total_wealth);
        const high = Math.max(...wealthValues);
        const low = Math.min(...wealthValues);

        document.getElementById("allTimeHigh").innerHTML =
          formatNumber(high) + '<span class="metric-unit">EGP</span>';
        document.getElementById("allTimeLow").innerHTML =
          formatNumber(low) + '<span class="metric-unit">EGP</span>';

        // Total change
        const change = latest.total_wealth - first.total_wealth;
        const changePercent =
          first.total_wealth > 0
            ? ((change / first.total_wealth) * 100).toFixed(2)
            : 0;

        const changeEl = document.getElementById("totalChange");
        const changePercentEl = document.getElementById("totalChangePercent");

        const isPositive = change >= 0;
        changeEl.innerHTML =
          (isPositive ? "+" : "") +
          formatNumber(change) +
          '<span class="metric-unit">EGP</span>';
        changeEl.className =
          "metric-value " + (isPositive ? "success" : "error");

        changePercentEl.className =
          "metric-change " + (isPositive ? "positive" : "negative");
        changePercentEl.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          ${
            isPositive
              ? '<polyline points="18 15 12 9 6 15"/>'
              : '<polyline points="6 9 12 15 18 9"/>'
          }
        </svg>
        <span>${isPositive ? "+" : ""}${changePercent}%</span>
      `;
      }

      // Wealth over time chart
      function updateWealthChart(data) {
        const ctx = document.getElementById("wealthChart").getContext("2d");

        if (charts.wealth) charts.wealth.destroy();

        charts.wealth = new Chart(ctx, {
          type: "line",
          data: {
            labels: data.map((d) => formatDate(d.timestamp)),
            datasets: [
              {
                label: "Total Wealth (EGP)",
                data: data.map((d) => d.total_wealth),
                borderColor: "#FFAB40",
                backgroundColor: "rgba(255, 171, 64, 0.1)",
                fill: true,
                tension: 0.4,
                pointRadius: data.length > 30 ? 0 : 4,
                pointHoverRadius: 6,
                pointBackgroundColor: "#FFAB40",
                pointBorderColor: "#0D0D0D",
                pointBorderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: "index",
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: "#252525",
                titleColor: "#FFFFFF",
                bodyColor: "#B0B0B0",
                borderColor: "#3D3D3D",
                borderWidth: 1,
                padding: 12,
                displayColors: false,
                callbacks: {
                  label: (ctx) => formatNumber(ctx.raw) + " EGP",
                },
              },
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { maxTicksLimit: 8 },
              },
              y: {
                grid: { color: "#2D2D2D" },
                ticks: {
                  callback: (value) => formatCompact(value),
                },
              },
            },
          },
        });
      }

      // Composition chart
      function updateCompositionChart(data) {
        const ctx = document
          .getElementById("compositionChart")
          .getContext("2d");
        const latest = data[data.length - 1];

        if (charts.composition) charts.composition.destroy();

        const goldValue = latest.gold_value || 0;
        const usdValue = latest.usd_value || 0;
        const total = goldValue + usdValue;

        const goldPct = total > 0 ? ((goldValue / total) * 100).toFixed(1) : 0;
        const usdPct = total > 0 ? ((usdValue / total) * 100).toFixed(1) : 0;

        document.getElementById("goldPercent").textContent = goldPct + "%";
        document.getElementById("usdPercent").textContent = usdPct + "%";

        charts.composition = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["Gold Holdings", "USD Balance"],
            datasets: [
              {
                data: [goldValue, usdValue],
                backgroundColor: ["#FFD700", "#4FC3F7"],
                borderColor: "#161616",
                borderWidth: 3,
                hoverOffset: 4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "70%",
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: "#252525",
                titleColor: "#FFFFFF",
                bodyColor: "#B0B0B0",
                borderColor: "#3D3D3D",
                borderWidth: 1,
                padding: 12,
                callbacks: {
                  label: (ctx) =>
                    ctx.label + ": " + formatNumber(ctx.raw) + " EGP",
                },
              },
            },
          },
        });
      }

      // Gold price chart
      function updateGoldPriceChart(data) {
        const ctx = document.getElementById("goldPriceChart").getContext("2d");

        if (charts.goldPrice) charts.goldPrice.destroy();

        // Support both price_history format and wealth data format
        const goldData = data.filter((d) => d.price || d.gold_price_24k);
        const usesPriceHistory = goldData.length > 0 && goldData[0].price !== undefined;

        charts.goldPrice = new Chart(ctx, {
          type: "line",
          data: {
            labels: goldData.map((d) => formatDate(d.timestamp)),
            datasets: [
              {
                label: "Gold 24K Price",
                data: goldData.map((d) => usesPriceHistory ? d.price : d.gold_price_24k),
                borderColor: "#FFD700",
                backgroundColor: "rgba(255, 215, 0, 0.1)",
                fill: true,
                tension: 0.4,
                pointRadius: goldData.length > 30 ? 0 : 4,
                pointHoverRadius: 6,
                pointBackgroundColor: "#FFD700",
                pointBorderColor: "#0D0D0D",
                pointBorderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: "index",
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: "#252525",
                titleColor: "#FFFFFF",
                bodyColor: "#B0B0B0",
                borderColor: "#3D3D3D",
                borderWidth: 1,
                padding: 12,
                displayColors: false,
                callbacks: {
                  label: (ctx) => formatNumber(ctx.raw) + " EGP/g",
                },
              },
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { maxTicksLimit: 8 },
              },
              y: {
                grid: { color: "#2D2D2D" },
                ticks: {
                  callback: (value) => formatCompact(value),
                },
              },
            },
          },
        });
      }

      // USD rate chart
      function updateUsdRateChart(data) {
        const ctx = document.getElementById("usdRateChart").getContext("2d");

        if (charts.usdRate) charts.usdRate.destroy();

        // Support both price_history format and wealth data format
        const usdData = data.filter((d) => d.price || d.usd_rate);
        const usesPriceHistory = usdData.length > 0 && usdData[0].price !== undefined;

        charts.usdRate = new Chart(ctx, {
          type: "line",
          data: {
            labels: usdData.map((d) => formatDate(d.timestamp)),
            datasets: [
              {
                label: "USD/EGP Rate",
                data: usdData.map((d) => usesPriceHistory ? d.price : d.usd_rate),
                borderColor: "#4FC3F7",
                backgroundColor: "rgba(79, 195, 247, 0.1)",
                fill: true,
                tension: 0.4,
                pointRadius: usdData.length > 30 ? 0 : 4,
                pointHoverRadius: 6,
                pointBackgroundColor: "#4FC3F7",
                pointBorderColor: "#0D0D0D",
                pointBorderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: "index",
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: "#252525",
                titleColor: "#FFFFFF",
                bodyColor: "#B0B0B0",
                borderColor: "#3D3D3D",
                borderWidth: 1,
                padding: 12,
                displayColors: false,
                callbacks: {
                  label: (ctx) => formatNumber(ctx.raw) + " EGP",
                },
              },
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { maxTicksLimit: 8 },
              },
              y: {
                grid: { color: "#2D2D2D" },
              },
            },
          },
        });
      }

      // Helper functions
      function formatNumber(num) {
        if (num === null || num === undefined) return "—";
        return new Intl.NumberFormat("en-US", {
          minimumFractionDigits: 0,
          maximumFractionDigits: 2,
        }).format(num);
      }

      function formatCompact(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + "M";
        if (num >= 1000) return (num / 1000).toFixed(1) + "K";
        return num.toString();
      }

      function formatDate(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
        });
      }

      function showLoading(show) {
        document.getElementById("loadingOverlay").classList.toggle("show", show);
      }

      function showEmptyState(show) {
        document.getElementById("emptyState").style.display = show
          ? "block"
          : "none";
        document.getElementById("analyticsContent").style.display = show
          ? "none"
          : "block";
      }
    </script>
  </body>
</html>
